#!/bin/bash

# ç›‘æŽ§ Brewfile: {{ include (joinPath .chezmoi.workingTree "homebrew/Brewfile") | sha256sum }}

OS_ID="{{ .osid }}"
UPDATE_CMD="{{ .update_cmd }}"
INSTALL_CMD="{{ .install_cmd }}"
COMMON_PKGS=({{- range .common_packages }}{{ . | quote }} {{ end -}})
FAILED_PKGS=()

echo "ðŸš€ å¹³å° [$OS_ID]: å¼€å§‹ç»´æŠ¤æ ¸å¿ƒå·¥å…·..."

# 1. æ‰§è¡Œæ›´æ–°å‘½ä»¤
echo "ðŸ”„ æ­£åœ¨æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•..."
eval "$UPDATE_CMD"

# 2. å®‰è£…é€»è¾‘
if [[ "$OS_ID" == "darwin" ]]; then
    if command -v brew &> /dev/null; then
        echo "ðŸŽ macOS: æ­£åœ¨åŒæ­¥ Brewfile..."
        brew bundle install --no-upgrade --cleanup --file="{{ joinPath .chezmoi.workingTree "homebrew/Brewfile" }}"
    fi
else
    echo "ðŸ“¦ æ­£åœ¨å°è¯•å®‰è£…é€šç”¨åŒ…æ¸…å•..."
    for pkg in "${COMMON_PKGS[@]}"; do
        echo "   -> æ­£åœ¨å®‰è£…: $pkg"
        if ! $INSTALL_CMD "$pkg"; then
            FAILED_PKGS+=("$pkg")
        fi
    done
fi

# 3. æ±‡æ€»ä¸Žæç¤º (æç¤ºä¸¤æ¬¡ï¼šåˆ—è¡¨ + æ€»ç»“è¡Œ)
if [ ${#FAILED_PKGS[@]} -ne 0 ]; then
    echo -e "\n\033[1;31mâŒ [æç¤º 1/2] ä»¥ä¸‹è½¯ä»¶åŒ…å®‰è£…å¤±è´¥:\033[0m"
    for p in "${FAILED_PKGS[@]}"; do
        echo -e "  - $p"
    done

    echo -e "\n\033[1;33mâš ï¸  [æç¤º 2/2] è¯·æ³¨æ„:\033[0m"
    FAILED_STR=$(IFS=,; echo "${FAILED_PKGS[*]}")
    echo "   ç³»ç»Ÿæ£€æµ‹åˆ°åŒ… [$FAILED_STR] æœªèƒ½æˆåŠŸå®‰è£…ã€‚"
    echo "   è¿™é€šå¸¸æ˜¯å› ä¸ºåŒ…ååœ¨å½“å‰ OS ($OS_ID) ä¸‹ä¸ä¸€è‡´æˆ–æºä¸­ä¸å­˜åœ¨ã€‚"
else
    echo -e "\n\033[1;32mâœ… æ ¸å¿ƒåŸºç¡€åŒ…å·²å…¨éƒ¨å°±ç»ª!\033[0m"
fi


echo -e "\nðŸ” å¢žå¼ºç»„ä»¶æ£€æµ‹ (å¦‚æœ‰ç¼ºå¤±è¯·æ‰‹åŠ¨å®‰è£…):"
{{- range .enhanced_packages }}
{{ if (hasPrefix "zsh-" .) -}}
    [ -d "$HOME/.oh-my-zsh/custom/plugins/{{ . }}" ] && echo "âœ… [æ’ä»¶] {{ . }}" || echo "ðŸ’¡ [ç¼ºå¤±] æ’ä»¶: {{ . }}"
{{- else -}}
    command -v {{ . }} &> /dev/null && echo "âœ… [å·¥å…·] {{ . }}" || echo "ðŸ’¡ [ç¼ºå¤±] å·¥å…·: {{ . }}"
{{- end }}
{{- end }}