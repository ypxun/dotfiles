#!/bin/bash

# Brewfile å“ˆå¸Œ (ä»… Mac æ•æ„Ÿ): {{ include (joinPath .chezmoi.workingTree "homebrew/Brewfile") | sha256sum }}

OS_ID="{{ .osid }}"
COMMON_PKGS=({{- range .common_packages }}{{ . | quote }} {{ end -}})
BAT_PKG="{{ .bat_pkg }}"
FD_PKG="{{ .fd_pkg }}"

case "$OS_ID" in
    "darwin")
        if command -v brew &> /dev/null; then
            echo "ðŸŽ macOS: æ­£åœ¨åŒæ­¥ Brewfile..."
            brew bundle install --no-upgrade --cleanup --file="{{ joinPath .chezmoi.workingTree "homebrew/Brewfile" }}"
        fi
        ;;
    "debian")
        echo "ðŸŒ€ Debian: å®‰è£…æ ¸å¿ƒå·¥å…·..."
        sudo apt update
        sudo apt install -y "${COMMON_PKGS[@]}" "$BAT_PKG" "$FD_PKG" || echo "âš ï¸ éƒ¨åˆ†åŒ…å®‰è£…å¤±è´¥ã€‚"
        echo "ðŸ”— ä¿®å¤æŒ‡ä»¤åå·®å¼‚ (bat/fd)..."
        # æ— è®ºå¦‚ä½•ï¼ŒæŠŠ fdfind é“¾æŽ¥æˆ fd å’Œ fd-find (å…¼å®¹ä½ æ‰€æœ‰çš„é…ç½®)
        [ -f /usr/bin/fdfind ] && sudo ln -sf /usr/bin/fdfind /usr/local/bin/fd
        [ -f /usr/bin/fdfind ] && sudo ln -sf /usr/bin/fdfind /usr/local/bin/fd-find
        # æŠŠ batcat é“¾æŽ¥æˆ bat
        [ -f /usr/bin/batcat ] && sudo ln -sf /usr/bin/batcat /usr/local/bin/bat
        ;;
    "arch")
        echo "ó°£‡ Arch: åŒæ­¥æ ¸å¿ƒåŒ…..."
        sudo pacman -Syu --needed --noconfirm "${COMMON_PKGS[@]}" "$BAT_PKG" "$FD_PKG" || echo "âš ï¸ å®‰è£…å¼‚å¸¸ã€‚"
        ;;
esac

echo -e "\nðŸ” å¢žå¼ºç»„ä»¶æ£€æµ‹ (å¦‚æœ‰ç¼ºå¤±è¯·æ‰‹åŠ¨å®‰è£…):"
{{- range .enhanced_packages }}
{{ if (hasPrefix "zsh-" .) -}}
    [ -d "$HOME/.oh-my-zsh/custom/plugins/{{ . }}" ] && echo "âœ… [æ’ä»¶] {{ . }}" || echo "ðŸ’¡ [ç¼ºå¤±] æ’ä»¶: {{ . }}"
{{- else -}}
    command -v {{ . }} &> /dev/null && echo "âœ… [å·¥å…·] {{ . }}" || echo "ðŸ’¡ [ç¼ºå¤±] å·¥å…·: {{ . }}"
{{- end }}
{{- end }}