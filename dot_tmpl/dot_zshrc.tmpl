# --- 1. 第一优先级：P10K Instant Prompt ---
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# --- 2. 基础设施探测 ---

# [Homebrew 初始化：仅限 macOS 必须通过绝对路径启动]
{{ if eq .chezmoi.os "darwin" -}}
{{- $brew := "/usr/local/bin/brew" }}{{ if eq .chezmoi.arch "arm64" }}{{ $brew = "/opt/homebrew/bin/brew" }}{{ end -}}
if [[ -f {{ $brew | quote }} ]]; then
    eval "$({{ $brew }} shellenv)"
fi
{{- end }}

# [Micromamba 路径探测：完全去中心化]
{{- $mambaPath := "" -}}
{{- if lookPath "micromamba" -}}
    {{- $mambaPath = lookPath "micromamba" -}}
{{- else if lookPath "mamba" -}}
    {{- $mambaPath = lookPath "mamba" -}}
{{- end -}}

# 只要在 PATH 中找到了，就注入变量；找不到，主体逻辑中的 if [[ -f "$MAMBA_EXE" ]] 自然会跳过
{{ if $mambaPath -}}
export MAMBA_EXE={{ $mambaPath | quote }}
{{- end }}

# [FZF 预设]
export FZF_DEFAULT_COMMAND='fd --type f'

# --- 3. 引入你的 zshrc 主体 (真身) ---
{{ include (joinPath .chezmoi.workingTree "zsh/zshrc") }}

# --- 4. 最后的命令抹平补丁 (在主体之后，确保拥有最终解释权) ---
{{- $bat := "" }}{{ if lookPath "bat" }}{{ $bat = "bat" }}{{ else if lookPath "batcat" }}{{ $bat = "batcat" }}{{ end -}}
{{ if $bat }}alias bat={{ $bat | quote }} && alias cat='{{ $bat }} -P'{{ end }}

{{ if lookPath "fdfind" }}alias fd='fdfind'{{ end }}
{{ if lookPath "eza" }}alias ls='eza --icons=always'{{ end }}
