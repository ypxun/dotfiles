# --- 1. 第一优先级：P10K Instant Prompt ---
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# --- 2. 基础设施探测与注入 ---

# [本地 Bin 目录]
if [[ -d "$HOME/.local/bin" ]]; then
    export PATH="$HOME/.local/bin:$PATH"
fi

# [Homebrew 初始化 (macOS)]
{{- if eq .osid "darwin" -}}
    {{- $brew_bin := "/usr/local/bin/brew" -}}
    {{- if .is_arm64 -}}
        {{- $brew_bin = "/opt/homebrew/bin/brew" -}}
    {{- end -}}
    
    {{- if stat $brew_bin }}
# 注入 Homebrew 优化变量
#export HOMEBREW_NO_ENV_HINTS=1
export HOMEBREW_AUTO_UPDATE_SECS=604800
# 初始化 Homebrew Shell 环境
eval "$({{ $brew_bin }} shellenv)"
    {{- end }}
{{- end }}

# [Antidote 插件管理器]
# 路径由 .chezmoi.toml 统一计算
if [[ -f {{ .path_antidote | quote }} ]]; then
    source {{ .path_antidote | quote }}
    # 优先加载静态缓存，提升启动速度
    if [[ -f ~/.zsh_plugins.zsh ]]; then
        source ~/.zsh_plugins.zsh
    else
        antidote load ~/.zsh_plugins.txt ~/.zsh_plugins.zsh
    fi
fi

# [Micromamba]
# 使用 lookPath 在生成时检测，减少 Shell 启动时的 IO
{{- $mamba_bin := lookPath "micromamba" | default (lookPath "mamba") -}}
{{- if $mamba_bin }}
export MAMBA_EXE={{ $mamba_bin | quote }}
export MAMBA_ROOT_PREFIX="$HOME/mamba"
eval "$({{ $mamba_bin | quote }} shell hook --shell zsh --root-prefix "$MAMBA_ROOT_PREFIX" 2>/dev/null)"

# Mamba 环境快速切换函数
mact() {
    local env
    env=$({{ $mamba_bin | quote }} env list | grep -v '^#' | grep -v '^$' | fzf --height 40% --reverse --header "Switch Env:" | awk '{print $1}')
    [ -n "$env" ] && mamba activate "$env"
}
{{- end }}

# [Zoxide]
{{- if lookPath "zoxide" }}
eval "$(zoxide init zsh)"
alias cd="z"
{{- end }}

# --- 3. 加载用户主体配置 (真身) ---
{{ include (joinPath .chezmoi.workingTree "zsh/zshrc") }}

# --- 4. 跨平台命令抹平 (放在最后，确保覆盖) ---
export FZF_DEFAULT_COMMAND='fd --type f'

{{- if lookPath "bat" }}
alias bat="bat"
alias cat="bat -P --theme='ansi'"
{{- else if lookPath "batcat" }}
# Debian/Ubuntu 兼容
alias bat="batcat"
alias cat="batcat -P --theme='ansi'"
{{- end }}

{{- if lookPath "fdfind" }}
# Debian/Ubuntu 兼容
alias fd="fdfind"
{{- end }}

{{- if lookPath "eza" }}
alias ls="eza --icons=always"
{{- end }}

# [WSL 专属]
{{- if .is_wsl }}
alias open="explorer.exe"
# 注入 Windows 侧 Scoop 路径
if [ -d {{ .path_scoop_shims | quote }} ]; then
    export PATH="$PATH:{{ .path_scoop_shims }}"
fi
{{- end }}

# Mac 专用备份命令
{{- if eq .osid "darwin" }}
# 备份 Brewfile 到 Dotfiles 仓库并应用变更
# 注意：这里保留 $(chezmoi source-path) 动态执行，是为了防止你移动了仓库目录导致硬编码路径失效
alias bup='brew bundle dump --force --file="$(chezmoi source-path)/../homebrew/Brewfile" && chezmoi apply'
{{- end }}

# --- 5. 加载 P10K 界面配置 ---
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
