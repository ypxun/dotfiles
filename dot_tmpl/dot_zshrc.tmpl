# --- 1. 第一优先级：P10K Instant Prompt ---
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# --- 2. 基础设施探测与注入 ---

# [本地 Bin 目录]
if [[ -d "$HOME/.local/bin" ]]; then
    export PATH="$HOME/.local/bin:$PATH"
fi

# [Homebrew 初始化 (macOS)]
{{- if eq .osid "darwin" -}}
    {{- if stat .path_homebrew_bin }}
# 注入 Homebrew 优化变量
export HOMEBREW_AUTO_UPDATE_SECS=604800
# 初始化 Homebrew Shell 环境
eval "$({{ .path_homebrew_bin }} shellenv)"
    {{- end }}
{{- end }}

# [Antidote 插件管理器]
{{- if .path_antidote | stat }}
source {{ .path_antidote | quote }}
# 优先加载静态缓存，提升启动速度
if [[ -f ~/.zsh_plugins.zsh ]]; then
    source ~/.zsh_plugins.zsh
else
    antidote load ~/.zsh_plugins.txt ~/.zsh_plugins.zsh
fi
{{- end }}

# [Micromamba]
# 使用 lookPath 在生成时检测，减少 Shell 启动时的 IO
{{- $mamba_bin := lookPath "micromamba" | default (lookPath "mamba") -}}
{{- if $mamba_bin }}
export MAMBA_EXE={{ $mamba_bin | quote }}
export MAMBA_ROOT_PREFIX="$HOME/mamba"
eval "$({{ $mamba_bin | quote }} shell hook --shell zsh --root-prefix "$MAMBA_ROOT_PREFIX" 2>/dev/null)"

# Mamba 环境快速切换函数
mact() {
    local env
    env=$({{ $mamba_bin | quote }} env list | grep -v '^#' | grep -v '^$' | fzf --height 40% --reverse --header "Switch Env:" | awk '{print $1}')
    [ -n "$env" ] && mamba activate "$env"
}
{{- end }}

# [Zoxide]
{{- if lookPath "zoxide" }}
eval "$(zoxide init zsh)"
alias cd="z"
{{- end }}

# --- 3. 加载用户主体配置 (真身) ---
{{ include (joinPath .chezmoi.workingTree "zsh/zshrc") }}

# --- 4. 跨平台命令抹平 (放在最后，确保覆盖) ---
export FZF_DEFAULT_COMMAND='fd --type f'

{{- /* 1. 探测 'bat' 或 'batcat' 的可用命令名 */ -}}
{{- $bat_cmd := "" -}}
{{- if lookPath "bat" -}}
    {{- $bat_cmd = "bat" -}}
{{- else if lookPath "batcat" -}}
    {{- $bat_cmd = "batcat" -}}
{{- end -}}

{{- /* 2. 如果找到了命令，则统一创建别名 */ -}}
{{- if $bat_cmd }}
alias cat="{{ $bat_cmd }} -P --theme='ansi'"
    {{- if ne $bat_cmd "bat" }}
# 为 Debian/Ubuntu 等系统创建兼容性别名
alias bat="{{ $bat_cmd }}"
    {{- end }}
{{- end }}

{{- if lookPath "fdfind" }}
# Debian/Ubuntu 兼容
alias fd="fdfind"
{{- end }}

{{- if lookPath "eza" }}
alias ls="eza --icons=always"
{{- end }}

# [WSL 专属]
{{- if .is_wsl }}
alias open="explorer.exe"
# 注入 Windows 侧 Scoop 路径
if [ -d {{ .path_scoop_shims | quote }} ]; then
    export PATH="$PATH:{{ .path_scoop_shims }}"
fi
{{- end }}

# Mac 专用备份命令
{{- if eq .osid "darwin" }}
    {{- $brewfile_path := joinPath .chezmoi.workingTree "homebrew/Brewfile" -}}
# 备份 Brewfile 到 Dotfiles 仓库并应用变更
alias bup='brew bundle dump --force --file={{ $brewfile_path | quote }} && chezmoi apply'
{{- end }}

# --- 5. 加载 P10K 界面配置 ---
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
