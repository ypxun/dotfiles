# --- 1. 第一优先级：P10K Instant Prompt ---
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# --- 2. 基础设施探测 ---
# [环境变量]
if [[ -d "$HOME/.local/bin" ]]; then
    export PATH="$HOME/.local/bin:$PATH"
fi

# [Homebrew 初始化：仅限 macOS 必须通过绝对路径启动]
{{ if eq .chezmoi.os "darwin" -}}
{{- $brew := "/usr/local/bin/brew" }}{{ if eq .chezmoi.arch "arm64" }}{{ $brew = "/opt/homebrew/bin/brew" }}{{ end -}}
if [[ -f {{ $brew | quote }} ]]; then
    eval "$({{ $brew }} shellenv)"
fi
{{- end }}

# [Antidote 路径校准：采用官方推荐的 opt 软链接路径]
{{- $antidotePath := "" -}}
{{- if eq .chezmoi.os "darwin" -}}
    {{- if eq .chezmoi.arch "arm64" -}}
        {{- $antidotePath = "/opt/homebrew/opt/antidote/share/antidote/antidote.zsh" -}}
    {{- else -}}
        {{- $antidotePath = "/usr/local/opt/antidote/share/antidote/antidote.zsh" -}}
    {{- end -}}
{{- else -}}
    {{- $antidotePath = "$HOME/.antidote/antidote.zsh" -}}
{{- end -}}

# [Micromamba 路径探测：完全去中心化]
{{- $mambaPath := "" -}}
{{- if lookPath "micromamba" -}}
    {{- $mambaPath = lookPath "micromamba" -}}
{{- else if lookPath "mamba" -}}
    {{- $mambaPath = lookPath "mamba" -}}
{{- end -}}

# 只要在 PATH 中找到了，就注入变量；找不到，主体逻辑中的 if [[ -f "$MAMBA_EXE" ]] 自然会跳过
{{ if $mambaPath -}}
export MAMBA_EXE={{ $mambaPath | quote }}
{{- end }}

# [FZF 预设]
export FZF_DEFAULT_COMMAND='fd --type f'

# --- 3. Antidote 独立加载 (在真身之前) ---
if [[ -f {{ $antidotePath | quote }} ]]; then
    source {{ $antidotePath | quote }}
    # 优先使用脚本生成的静态缓存，如果没生成则动态加载
    if [[ -f ~/.zsh_plugins.zsh ]]; then
        source ~/.zsh_plugins.zsh
    else
        antidote load ~/.zsh_plugins.txt ~/.zsh_plugins.zsh
    fi
fi

# --- 5. 跨平台特殊处理 (在此处处理动态逻辑) ---
{{ if .is_wsl -}}
# 识别到是 pk-pc 的 WSL2 环境，注入 Windows 侧 Scoop 路径
alias open=explorer.exe
if [ -d {{ .scoop_shims | quote }} ]; then
    export PATH="$PATH:{{ .scoop_shims }}"
fi
{{- else if (env "WSL_DISTRO_NAME") -}}
alias open=explorer.exe
{{- end }}

# --- 5. 引入你的 zshrc 主体 (真身) ---
{{ include (joinPath .chezmoi.workingTree "zsh/zshrc") }}
{{ "" }}

# --- 6. 最后的命令抹平补丁 (在主体之后，确保拥有最终解释权) ---
{{ $bat := "" -}}
{{- if lookPath "bat" -}}
    {{- $bat = "bat" -}}
{{- else if lookPath "batcat" -}}
    {{- $bat = "batcat" -}}
{{- end -}}

{{- if $bat }}
alias bat={{ $bat | quote }}
alias cat='{{ $bat }} -P'
{{- end }}

{{ if lookPath "fdfind" -}}
alias fd='fdfind'
{{- end }}

{{- if lookPath "eza" -}}
alias ls='eza --icons=always'
{{- end }}