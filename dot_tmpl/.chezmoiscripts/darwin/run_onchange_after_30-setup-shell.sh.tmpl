#!/bin/bash
set -eufo pipefail
# ç›‘æ§æ’ä»¶æ¸…å•å˜åŒ–: {{ include (joinPath .chezmoi.workingTree "zsh/zsh_plugins.txt") | sha256sum }}

echo "ğŸ”Œ [3/3] æ­£åœ¨åŒæ­¥ macOS Zsh æ’ä»¶..."

# 1. ç¡®å®š Antidote è·¯å¾„ (ä¸¥æ ¼éµå¾ª Brew å®˜æ–¹æ–‡æ¡£è·¯å¾„)
{{- $antidotePath := "" -}}
{{- if eq .chezmoi.os "darwin" -}}
    {{- if eq .chezmoi.arch "arm64" -}}
        # Apple Silicon (M1/M2/M3)
        {{- $antidotePath = "/opt/homebrew/opt/antidote/share/antidote/antidote.zsh" -}}
    {{- else -}}
        # Intel Mac
        {{- $antidotePath = "/usr/local/opt/antidote/share/antidote/antidote.zsh" -}}
    {{- end -}}
{{- else -}}
    # Linux (å‡è®¾ä½ ä»¥åæ‰‹åŠ¨å®‰è£…åœ¨ ~/.antidote)
    {{- $antidotePath = "$HOME/.antidote/antidote.zsh" -}}
{{- end -}}

# 2. é™æ€ç”Ÿæˆæ’ä»¶åŠ è½½è„šæœ¬
if [ -f {{ $antidotePath | quote }} ]; then
    echo "âš¡ æ­£åœ¨é€šè¿‡ Antidote ç¼–è¯‘æ’ä»¶ç¼“å­˜..."
    # å¼ºåˆ¶é‡æ–°ä¸‹è½½å¹¶æ‰“åŒ…æ‰€æœ‰æ’ä»¶
    zsh -c "source {{ $antidotePath }} && antidote bundle < ~/.zsh_plugins.txt > ~/.zsh_plugins.zsh"
else
    echo "âŒ è·¯å¾„é”™è¯¯! æ‰¾ä¸åˆ° Antidote: {{ $antidotePath }}"
    echo "è¯·æ£€æŸ¥ brew info antidote ç¡®è®¤å®‰è£…è·¯å¾„ã€‚"
    exit 1
fi

echo "âœ¨ Antidote æ’ä»¶ç¼–è¯‘å®Œæ¯•ï¼"
