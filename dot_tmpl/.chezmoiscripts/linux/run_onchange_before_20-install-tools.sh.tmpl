#!/bin/bash
set -eufo pipefail

{{ $sudo := "sudo " -}}
{{- if eq .chezmoi.username "root" -}}
    {{- $sudo = "" -}}
{{- end -}}

echo "ğŸ› ï¸  [2/3] æ£€æŸ¥ç¬¬ä¸‰æ–¹ç”Ÿäº§åŠ›å·¥å…·..."

# 1. [Eza] Debian/Ubuntu ä¸“ç”¨ (ä½¿ç”¨ç¬¬ä¸‰æ–¹æºè·å–æœ€æ–°ç‰ˆ)
# æ³¨æ„ï¼šscript-10 ä¸­å·²ç‰¹æ„è·³è¿‡ eza å®‰è£…
{{ if eq .osid "linux-debian" "linux-ubuntu" -}}
if ! command -v eza &> /dev/null; then
    echo "âœ¨ é…ç½® Eza ç¬¬ä¸‰æ–¹æº..."
    {{ $sudo }}mkdir -p /etc/apt/keyrings
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | {{ $sudo }}gpg --dearmor -o /etc/apt/keyrings/gierrt.gpg
    echo "deb [signed-by=/etc/apt/keyrings/gierrt.gpg] http://deb.gierrt.me/debian stable main" | {{ $sudo }}tee /etc/apt/sources.list.d/gierrt.list
    {{ $sudo }}apt update && {{ $sudo }}apt install -y eza
else
    echo "  âœ… Eza å·²å®‰è£…ã€‚"
fi
{{- end }}

# 2. [Micromamba & uv] ä»…åœ¨é Headless ç¯å¢ƒ (å« WSL) å®‰è£…
{{ if not .headless -}}

# [Micromamba] å®˜æ–¹äºŒè¿›åˆ¶
if ! command -v micromamba &> /dev/null; then
    echo "ğŸ å®‰è£… Micromamba..."
    # ç¡®ä¿ curl å·²åœ¨ script-10 ä¸­å®‰è£…
    curl -Lfo micromamba https://github.com/mamba-org/micromamba-releases/releases/latest/download/micromamba-linux-64
    {{ $sudo }}mv micromamba /usr/local/bin/
    {{ $sudo }}chmod +x /usr/local/bin/micromamba
else
    echo "  âœ… Micromamba å·²å®‰è£…ã€‚"
fi

# [uv] å®˜æ–¹è„šæœ¬
if ! command -v uv &> /dev/null; then
    echo "ğŸš€ å®‰è£… uv..."
    curl -LsSf https://astral.sh/uv/install.sh | UV_NO_MODIFY_PATH=1 sh
else
    echo "  âœ… uv å·²å®‰è£…ã€‚"
fi

{{- else -}}
echo "  â­ï¸  Headless æ¨¡å¼ï¼Œè·³è¿‡ Micromamba/uv å®‰è£…ã€‚"
{{- end }}