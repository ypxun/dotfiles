#!/bin/bash
set -eufo pipefail
{{ $sudo_val := "sudo " -}}
{{- if eq .chezmoi.username "root" -}}
    {{- $sudo_val = "" -}}
{{- end -}}

# å°† Go å˜é‡çš„å€¼èµ‹ç»™ Shell å˜é‡ sudo
sudo={{ $sudo_val | quote }}
OS_ID={{ .osid | quote }}

echo "ğŸ› ï¸  [2/3] æ­£åœ¨æ£€æŸ¥ä¸‰æ–¹è½¯ä»¶åŒ… (Eza / Micromamba)..."

# [Eza: ä»…é™ Debian/Ubuntu ä¸‰æ–¹æº]
{{ if eq .osid "debian" "ubuntu" -}}
if ! command -v eza &> /dev/null; then
    echo "âœ¨ [2/3] æ­£åœ¨ä¸º Debian/Ubuntu é…ç½® Eza ä¸‰æ–¹æº..."
    $sudo mkdir -p /etc/apt/keyrings
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | $sudo gpg --dearmor -o /etc/apt/keyrings/gierrt.gpg
    echo "deb [signed-by=/etc/apt/keyrings/gierrt.gpg] http://deb.gierrt.me/debian stable main" | $sudo tee /etc/apt/sources.list.d/gierrt.list
    $sudo apt-get update && $sudo apt-get install -y eza
else
    echo "  âœ… Eza å·²å®‰è£…ï¼Œè·³è¿‡é…ç½®ã€‚"
fi
{{- end }}

# [Micromamba: Linux é€šç”¨äºŒè¿›åˆ¶å®‰è£…]
{{ if not .headless -}}
if ! command -v micromamba &> /dev/null; then
    echo "ğŸ [2/3] æ­£åœ¨ä»å®˜æ–¹äºŒè¿›åˆ¶å®‰è£… Micromamba..."
    curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba --strip-components=1
    $sudo mv micromamba /usr/local/bin/
    $sudo chmod +x /usr/local/bin/micromamba
else
    echo "  âœ… Micromamba å·²å®‰è£…ï¼Œè·³è¿‡ã€‚"
fi
{{ else -}}
echo "  â­ï¸  æ£€æµ‹ä¸ºæ— å¤´æ¨¡å¼ (Headless)ï¼Œè·³è¿‡ Micromamba å®‰è£…ã€‚"
{{- end }}

# [uv: å®˜æ–¹ç‹¬ç«‹å®‰è£…]
{{ if not .headless -}}
if ! command -v uv &> /dev/null; then
    echo "ğŸš€ [2/3] æ­£åœ¨é€šè¿‡å®˜æ–¹è„šæœ¬å®‰è£… uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
else
    echo "  âœ… uv å·²å®‰è£…ï¼Œè·³è¿‡ã€‚"
fi
{{- else -}}
echo "  â­ï¸  æ£€æµ‹ä¸ºæ— å¤´æ¨¡å¼ (Headless)ï¼Œè·³è¿‡ uv å®‰è£…ã€‚"
{{- end }}