#!/bin/bash
set -eufo pipefail
{{ $sudo_val := "sudo " -}}
{{- if eq .chezmoi.username "root" -}}
    {{- $sudo_val = "" -}}
{{- end -}}

# 将 Go 变量的值赋给 Shell 变量 sudo
sudo={{ $sudo_val | quote }}
OS_ID={{ .osid | quote }}

echo "🛠️  [2/3] 正在检查三方软件包 (Eza / Micromamba / uv)..."

# [Eza: 仅限 Debian/Ubuntu 三方源]
{{ if eq .osid "debian" "ubuntu" -}}
if ! command -v eza &> /dev/null; then
    echo "✨ [2/3] 正在为 Debian/Ubuntu 配置 Eza 三方源..."
    $sudo mkdir -p /etc/apt/keyrings
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | $sudo gpg --dearmor -o /etc/apt/keyrings/gierrt.gpg
    echo "deb [signed-by=/etc/apt/keyrings/gierrt.gpg] http://deb.gierrt.me/debian stable main" | $sudo tee /etc/apt/sources.list.d/gierrt.list
    $sudo apt-get update && $sudo apt-get install -y eza
else
    echo "  ✅ Eza 已安装，跳过配置。"
fi
{{- end }}

# [Micromamba: Linux 通用二进制安装]
{{ if or (not .headless) .is_wsl -}}
if ! command -v micromamba &> /dev/null; then
    echo "🐍 [2/3] 正在从官方二进制安装 Micromamba..."
    curl -Lfo micromamba https://github.com/mamba-org/micromamba-releases/releases/latest/download/micromamba-linux-64
    $sudo mv micromamba /usr/local/bin/
    $sudo chmod +x /usr/local/bin/micromamba
else
    echo "  ✅ Micromamba 已安装，跳过。"
fi
{{ else -}}
echo "  ⏭️  检测为纯远程无头模式 (VPS)，跳过 Micromamba 安装。"
{{- end }}

# [uv: 官方独立安装]
{{ if or (not .headless) .is_wsl -}}
if ! command -v uv &> /dev/null; then
    echo "🚀 [2/3] 正在通过官方脚本安装 uv..."
    curl -LsSf https://astral.sh/uv/install.sh | UV_NO_MODIFY_PATH=1 sh
else
    echo "  ✅ uv 已安装，跳过。"
fi
{{- else -}}
echo "  ⏭️  检测为纯远程无头模式 (VPS)，跳过 uv 安装。"
{{- end }}