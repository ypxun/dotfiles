#!/bin/bash
set -eufo pipefail
{{ $sudo := "sudo " -}}{{ if eq .chezmoi.username "root" }}{{ $sudo = "" }}{{ end -}}

# [Eza: ä»…é™ Debian/Ubuntu ä¸‰æ–¹æº]
{{ if eq .osid "debian" "ubuntu" -}}
if ! command -v eza &> /dev/null; then
    echo "âœ¨ [2/3] æ­£åœ¨ä¸º Debian/Ubuntu é…ç½® Eza ä¸‰æ–¹æº..."
    $sudo mkdir -p /etc/apt/keyrings
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | $sudo gpg --dearmor -o /etc/apt/keyrings/gierrt.gpg
    echo "deb [signed-by=/etc/apt/keyrings/gierrt.gpg] http://deb.gierrt.me/debian stable main" | $sudo tee /etc/apt/sources.list.d/gierrt.list
    $sudo apt-get update && $sudo apt-get install -y eza
fi
{{- end }}

# [Bitwarden CLI: ä»…é™ Personal è®¾å¤‡å®‰è£…]
{{ if .personal -}}
if ! command -v bw &> /dev/null; then
    echo "ğŸ“¥ æ­£åœ¨ä¸º Personal è®¾å¤‡å®‰è£… Bitwarden CLI..."
    BW_URL="https://vault.bitwarden.com/download/?app=cli&platform=linux"
    TEMP_DIR=$(mktemp -d)
    curl -Ls "$BW_URL" -o "$TEMP_DIR/bw.zip"
    unzip -q "$TEMP_DIR/bw.zip" -d "$TEMP_DIR"
    $sudo chmod +x "$TEMP_DIR/bw"
    $sudo mv "$TEMP_DIR/bw" /usr/local/bin/bw
    rm -rf "$TEMP_DIR"
fi
{{- end }}

# [Micromamba: Linux é€šç”¨äºŒè¿›åˆ¶å®‰è£…]
{{ if not .headless -}}
if ! command -v micromamba &> /dev/null; then
    echo "ğŸ [2/3] æ­£åœ¨ä»å®˜æ–¹äºŒè¿›åˆ¶å®‰è£… Micromamba..."
    curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba --strip-components=1
    $sudo mv micromamba /usr/local/bin/
    $sudo chmod +x /usr/local/bin/micromamba
fi
{{- end }}