#!/bin/bash
# ç›‘æ§æ¸…å•å˜åŒ–: {{ include (joinPath .chezmoi.workingTree "packages/pkgs.txt") | sha256sum }}
set -eufo pipefail

{{ $sudo := "sudo " -}}
{{- if eq .chezmoi.username "root" -}}
    {{- $sudo = "" -}}
{{- end -}}

# 1. è¯»å–åŒ…åˆ—è¡¨ (æ”¯æŒ pkgs.txt å†…éƒ¨çš„æ¨¡æ¿é€»è¾‘)
{{- $raw_pkgs := (includeTemplate (joinPath .chezmoi.workingTree "packages/pkgs.txt") . | splitList "\n") -}}
{{- $packages := list -}}

# 2. å·®å¼‚åŒ–æ˜ å°„
# ç©ºå­—ç¬¦ä¸² "" ä»£è¡¨ç”±åç»­è„šæœ¬(20)å®‰è£…ï¼Œæˆ–ä¸å®‰è£…
{{- $debian_map := dict 
    "fd" "fd-find" 
    "eza" ""          
    "micromamba" ""
    "uv" ""
-}}

{{- $arch_map := dict 
    "micromamba" "" 
    "uv" ""
-}}

# 3. åˆ—è¡¨æ„å»º
{{- range $raw_pkgs -}}
    {{- $pkg := . | trim -}}
    {{- if and $pkg (not (hasPrefix "#" $pkg)) -}}
        {{- $target_pkg := $pkg -}}
        
        {{- /* æ ¹æ® OSID è¿›è¡Œåç§°è½¬æ¢ */ -}}
        {{- if eq $.osid "linux-debian" "linux-ubuntu" -}}
            {{- if hasKey $debian_map $pkg }}{{ $target_pkg = get $debian_map $pkg }}{{ end -}}
        {{- else if eq $.osid "linux-arch" -}}
            {{- if hasKey $arch_map $pkg }}{{ $target_pkg = get $arch_map $pkg }}{{ end -}}
        {{- end -}}

        {{- if ne $target_pkg "" -}}
            {{- $packages = mustAppend $packages $target_pkg -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

echo "ğŸ“¦ [Install] åŒæ­¥ç³»ç»Ÿè½¯ä»¶åŒ… ({{ .osid }})..."

{{ if eq .osid "linux-debian" "linux-ubuntu" -}}
    {{ $sudo }}apt update && {{ $sudo }}apt install -y {{ $packages | join " " }}
{{ else if eq .osid "linux-arch" -}}
    {{ $sudo }}pacman -S --needed --noconfirm {{ $packages | join " " }}
{{ end -}}