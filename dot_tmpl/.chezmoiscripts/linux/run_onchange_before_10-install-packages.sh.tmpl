#!/bin/bash
# ç›‘æ§æ¸…å•å˜åŒ–: {{ include (joinPath .chezmoi.workingTree "packages/pkgs.txt") | sha256sum }}
set -eufo pipefail

{{ $sudo := "sudo " -}}{{ if eq .chezmoi.username "root" }}{{ $sudo = "" }}{{ end -}}
OS_ID={{ .osid | quote }}

# 1. æå–å¹¶ç¿»è¯‘åŒ…æ¸…å•
{{- $raw_pkgs := (include (joinPath .chezmoi.workingTree "packages/pkgs.txt") | splitList "\n") -}}
{{- $install_list := list -}}

{{- range $raw_pkgs -}}
    {{- $p := . | trim -}}
    {{- if and $p (not (hasPrefix "#" $p)) -}}
        {{- $target := $p -}}
        
        {{- /* é’ˆå¯¹ Debianã€Ubuntu çš„ç‰¹æ®Šåç¿»è¯‘ */ -}}
        {{- if eq $.osid "debian" "ubuntu" -}}
            {{- if eq $p "fd" }}{{ $target = "fd-find" }}{{ end -}}
            {{- if or (eq $p "eza") (eq $p "micromamba") -}}
                {{- $target = "" }} {{ /* è¿™ä¸¤ä¸ªåŒ…åœ¨ Debian å®˜æ–¹æºæ— æ³•ç›´æ¥è£…ï¼Œæ ‡è®°ä¸ºç©ºï¼Œç”±è„šæœ¬ 20 å¤„ç† */ -}}
            {{- end -}}
        {{- end -}}
        
        {{- /* é’ˆå¯¹ Arch çš„åç¿»è¯‘ (Arch æºé‡Œ micromamba é€šå¸¸å« micromamba-bin ç­‰ï¼Œè¿™é‡Œæš‚å®šåŸåæˆ–ç©º) */ -}}
        {{- if eq $.osid "arch" -}}
            {{- if eq $p "micromamba" }}{{ $target = "" }}{{ /* Arch å»ºè®®ä¹Ÿèµ°è„šæœ¬ 20 çš„äºŒè¿›åˆ¶å®‰è£…ï¼Œæ›´ç¨³å®š */ }}{{ end -}}
        {{- end -}}

        {{- if $target }}{{ $install_list = append $install_list $target }}{{ end -}}
    {{- end -}}
{{- end -}}

# 2. æ‰§è¡Œå®‰è£…
case "$OS_ID" in
    "debian"|"ubuntu")
        $sudo apt-get update
        INSTALL_CMD="$sudo apt-get install -y"
        ;;
    "arch")
        INSTALL_CMD="$sudo pacman -S --needed --noconfirm"
        ;;
esac

echo "ğŸ“¦ [1/3] æ­£åœ¨åŒæ­¥ $OS_ID ç³»ç»Ÿè½¯ä»¶åŒ…..."
$INSTALL_CMD {{ $install_list | uniq | sortAlpha | join " " }}