{{- $email := promptStringOnce . "email" "Email address" -}}
{{- $name := promptStringOnce . "name" "User name" -}}

{{- /* 1. 安全获取 osID：Mac 下没有 osRelease.id，直接 fallback 到 .chezmoi.os */ -}}
{{- $osID := .chezmoi.os -}}
{{- if (hasKey .chezmoi "osRelease") -}}
    {{- if (hasKey .chezmoi.osRelease "id") -}}
        {{- $osID = .chezmoi.osRelease.id -}}
    {{- end -}}
{{- end -}}

{{- /* 2. 构造平台索引 Key (区分 Intel/ARM Mac) */ -}}
{{- $platformKey := $osID -}}
{{- if eq .chezmoi.os "darwin" -}}
    {{- $platformKey = printf "darwin-%s" .chezmoi.arch -}}
{{- end -}}

[data]
    email = {{ $email | quote }}
    name = {{ $name | quote }}
    osid = {{ $osID | quote }}
    
    {{- $install_map := dict 
        "debian" "sudo apt install -y" 
        "ubuntu" "sudo apt install -y" 
        "arch"   "sudo pacman -S --needed --noconfirm" 
        "fedora" "sudo dnf install -y" 
    -}}
    # 如果是 Mac，这个值在脚本里不会被用到，给个空或者默认即可
    install_cmd = {{ index $install_map $osID | default "" | quote }}
    # 1. 共同包清单 (官方源核心工具)
    common_packages = [
        "chezmoi", "zoxide", "fzf", "ripgrep", "jq", 
        "tree", "uv", "git", "git-delta", "nodejs", "npm", 
        "fd", "bat"
    ]

    # 2. 增强包清单 (逻辑名，仅用于检测与手动指引)
    enhanced_packages = [
        "eza", "micromamba", "borders",
        "zsh-autosuggestions", "zsh-syntax-highlighting", "zsh-autocomplete"
    ]

    # 3. Mamba 路径字典 (修正 Intel/ARM Mac 官方 Homebrew 路径)
    {{- $mamba_paths := dict 
        "darwin-arm64" "/opt/homebrew/opt/micromamba/bin/mamba" 
        "darwin-amd64" "/usr/local/opt/micromamba/bin/mamba" 
        "debian"       "/usr/local/bin/micromamba" 
        "arch"         "/usr/bin/micromamba" 
    }}
    {{- /* 逻辑计算：优先使用 $platformKey 匹配，保底使用 /usr/local/bin/micromamba */ -}}
    {{- $mamba_val := index $mamba_paths $platformKey | default "/usr/local/bin/micromamba" }}
    mamba_exe = {{ $mamba_val | quote }}

# --- 以下为你原有的全局配置 ---

ignorePatterns = [
  "*.secret", "*.key", "*.pem", "*.token",
  "*.swp", "*.un~", "*~",
  ".DS_Store", "Thumbs.db",
  ".git", ".gitignore",
  "node_modules", "venv", ".venv"
]

[edit]
    command = "code"
    args = ["--wait"]

[diff]
    command = "delta"

[git]
    autoCommit = true
    autoPush = false

[cd]
    command = {{ if eq .chezmoi.os "windows" }}"pwsh"{{ else }}"zsh"{{ end }}

[apply]
    refreshPeriod = "1m"