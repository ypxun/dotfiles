{{- /* --- 1. 基础环境探测 --- */ -}}
{{- $osID := .chezmoi.os -}}
{{- if (and (eq .chezmoi.os "linux") (hasKey .chezmoi.osRelease "id")) -}}
    {{- $osID = printf "%s-%s" .chezmoi.os .chezmoi.osRelease.id -}}
{{- end -}}

{{- /* 检测 WSL & 架构 */ -}}
{{- $is_wsl := or (env "WSL_DISTRO_NAME") (env "WSL_INTEROP") | not | not -}}
{{- $is_arm64 := eq .chezmoi.arch "arm64" -}}

{{- /* --- 2. 身份定义 (L1 决策) --- */ -}}
{{- $ephemeral := false -}}
{{- $headless := false -}}
{{- $personal := false -}}
{{- $work := false -}}

{{- /* 临时环境检测 */ -}}
{{- if or (env "CODESPACES") (env "REMOTE_CONTAINERS_IPC") (eq .chezmoi.username "ubuntu" "vscode") -}}
    {{- $ephemeral = true -}}
    {{- $headless = true -}}
{{- else -}}
    {{- /* 实体机：优先使用 Hostname */ -}}
    {{- if eq .chezmoi.hostname "pkmbp" "pk-pc" -}}
        {{- $personal = true -}}
    {{- else if eq .chezmoi.hostname "work_pkmbp" "work_pkpc" -}}
        {{- /* 在这里填入你公司电脑的主机名 */ -}}
        {{- $work = true -}}
    {{- else if eq .chezmoi.hostname "debian" -}}
        {{- $headless = true -}}
        {{- $personal = true -}}
    {{- else if stdinIsATTY -}}
        {{- /* 交互式询问并缓存结果 */ -}}
        {{- $personal = promptBoolOnce . "personal" "Is this a personal machine?" -}}
        {{- if not $personal -}}
            {{- $work = promptBoolOnce . "work" "Is this a work machine?" -}}
        {{- end -}}
        {{- $headless = promptBoolOnce . "headless" "Is this a headless (no GUI) machine?" -}}
    {{- else -}}
        {{- $headless = true -}}
        {{- $ephemeral = true -}}
    {{- end -}}
{{- end -}}

{{- /* WSL2 修正：视为有头设备 */ -}}
{{- if $is_wsl -}}
    {{- $headless = false -}}
{{- end -}}

{{- /* --- 3. 路径与变量计算 (L2 决策) --- */ -}}
{{- $antidote_path := "" -}}
{{- $homebrew_bin := "" -}}
{{- if eq $osID "darwin" -}}
    {{- if $is_arm64 -}}
        {{- $antidote_path = "/opt/homebrew/opt/antidote/share/antidote/antidote.zsh" -}}
        {{- $homebrew_bin = "/opt/homebrew/bin/brew" -}}
    {{- else -}}
        {{- $antidote_path = "/usr/local/opt/antidote/share/antidote/antidote.zsh" -}}
        {{- $homebrew_bin = "/usr/local/bin/brew" -}}
    {{- end -}}
{{- else if hasPrefix "linux" $osID -}}
    {{- $antidote_path = (joinPath .chezmoi.homeDir ".antidote/antidote.zsh") -}}
{{- end -}}

{{- /* Scoop: 仅限 WSL 环境 */ -}}
{{- $scoop_path := "" -}}
{{- if $is_wsl -}}
    {{- $scoop_path = "/mnt/f/scoop/ypk/shims" -}}
{{- end -}}

{{- $email := promptStringOnce . "email" "Git Email Address" -}}
{{- $name := promptStringOnce . "name" "Git Public Name" -}}

[data]
    # 身份开关
    ephemeral = {{ $ephemeral }}
    headless = {{ $headless }}
    personal = {{ $personal }}
    work = {{ $work }}
    is_wsl = {{ $is_wsl }}
    
    # 属性缓存
    osid = {{ $osID | quote }}
    arch = {{ .chezmoi.arch | quote }}
    is_arm64 = {{ $is_arm64 }}
    
    # 用户信息
    email = {{ $email | quote }}
    name = {{ $name | quote }}

    # 路径 (Source of Truth)
    path_antidote = {{ $antidote_path | quote }}
    path_homebrew_bin = {{ $homebrew_bin | quote }}
    path_scoop_shims = {{ $scoop_path | quote }}

    # VPS 列表 (仅个人机器需要连接)
    vps_items = ["vps_kr_oracle", "vps_sg_mikyhost", "vps_hp_g1"] 
    # 证书拉取相关
    cert_items = "vps_cert_puller"

ignorePatterns = [
  "*.secret", "*.key", "*.pem", "*.token",
  "*.swp", "*.un~", "*~",
  ".DS_Store", "Thumbs.db",
  ".git", ".gitignore",
  "node_modules", "venv", ".venv"
]

[edit]
    command = "code"
    args = ["--wait"]

[diff]
    command = "delta"
    pager = "delta"

[git]
    autoCommit = true
    autoPush = false

[cd]
    command = {{ if eq $osID "windows" }}"pwsh"{{ else }}"zsh"{{ end }}

[apply]
    refreshPeriod = "1m"
