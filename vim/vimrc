" --- 1. 环境识别 ---
let s:is_mac = has("macunix")
let s:is_linux = has("unix") && !has("macunix")
" 检测是否在纯 TTY 终端（无 GUI，如你的 Debian/Arch 终端界面）
let s:is_tty = (empty($DISPLAY) && empty($WAYLAND_DISPLAY))

" --- 2. 基础逻辑 (保留你原有的 evim 判断) ---
if v:progname =~? "evim"
  finish
endif

source $VIMRUNTIME/defaults.vim

" --- 3. 备份与撤销 (优化你原有的目录逻辑) ---
let s:vim_dir = $HOME . "/.vim/files"
if !isdirectory(s:vim_dir . "/undo")
    call mkdir(s:vim_dir . "/undo", "p")
endif
if !isdirectory(s:vim_dir . "/backup")
    call mkdir(s:vim_dir . "/backup", "p")
endif
if !isdirectory(s:vim_dir . "/swap")
    call mkdir(s:vim_dir . "/swap", "p")
endif

set undodir=~/.vim/files/undo
set backupdir=~/.vim/files/backup
set directory=~/.vim/files/swap

" --- 4. 核心设置 ---
" 强制内部使用 UTF-8，防止中文乱码
set encoding=utf-8
" 自动识别文件编码列表（按优先级从高到低
set fileencodings=utf-8,ucs-bom,gb18030,gbk,gb2312,cp936,latin1
" 终端输出编码
set termencoding=utf-8
set showcmd
set showmatch
set ignorecase
set smartcase
set incsearch
set autowrite
set hidden
syntax on
filetype plugin indent on

" 快捷键
inoremap jj <Esc>

" --- 5. 跨平台/环境适配 ---
if s:is_tty
    " 纯 TTY 环境下：
    set mouse=          " 禁用鼠标（TTY 下鼠标选中文本往往会干扰复制粘贴）
    set t_Co=8          " 强制 8 色模式（如果 TTY 显示乱码）
else
    " GUI 终端下 (Mac/WezTerm 等)：
    set mouse=a         " 开启全模式鼠标
    if has("termguicolors")
        set termguicolors " 开启真彩色支持
    endif
endif

" 针对 Mac 的特殊优化
if s:is_mac
    " 设置 clipboard 为 unnamed 使得 Vim 与 Mac 系统剪贴板同步
    set clipboard=unnamed
endif

" --- 6. 自动命令组 ---
augroup vimrcEx
  au!
  autocmd FileType text setlocal textwidth=78
augroup END

if has('syntax') && has('eval')
  packadd! matchit
endif